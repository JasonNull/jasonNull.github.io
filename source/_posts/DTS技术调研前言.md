---
title: DTS技术调研前言
date: 2018-06-28 21:33:23
tags:
- 中间件
- 开源
categories:
- 开源
---
# quartz
对现有方式做单机性能测试，下面是相关测试结果：
- mysql，单秒100个任务（主要是数据库锁加锁过程比较慢）
- redis，单秒150个任务（开源代码，实现不是很好，主要表现为，不稳定，连接池经常耗尽，并且可能会遭遇任务数据丢失场景）
- ram，每秒1500个任务

总结下来可能还是会继续使用mysql做quartz的持久化，但是会针对性的做一些性能优化。
比如以下场景：
1. 加锁方式上，可能不再采用数据库锁，采用redis或者zk来实现分布式锁
2. 加锁粒度上，减小锁的粒度，从而减少锁的占用时间，提高吞吐量
<!-- more -->

# 数据库
数据库优化打算采用以下两种方式：
- tidb，分布式关系型数据库，成规模部署性能比较高，单机部署性能比较差。
- mysql分库分表，两库共四表，用于减轻数据库锁的压力

为什么最后采用分库分表？
1. 没有好的分布式关系型数据库支撑，tidb开源版本体验不够好，资料不是很多，本地测试一堆问题。
2. 架构层面分库分表更简单，对硬件没有什么特殊要求，只是要求多用几个库表。

# 架构
1. 引入分发层
    1. 单机，默认分发方式，可用性更高（不依赖其他外部存储），单个任务的分发时间会更短
    2. redis多机，通过配置redis自动生效，总体分发性能更高，
    3. 自动模式，根据任务数量，自动选择分发模式
2. 引入通信层
    1. jetty，现有通信方式，通信损耗较高
    2. netty，改进方式，使用长连接
3. 引入调度层
    1. 解耦quartz，减少对quartz的依赖
    2. 方便后续对quartz以及去quartz改造
4. 引入redis
    1. 任务多机分发，将任务放入redis队列中，然后消费队列数据（需要处理redis宕机场景，走单机分发或者补偿逻辑）
    2. 加快quartz的加锁机制，数据库加锁较慢