---
title: é‡æ’åº
date: 2018-06-23 16:09:49
tags:
- java
- jvm
categories:
- java
- jvm
toc: true
---
## åˆ†ç±»
1. ç¼–è¯‘å™¨é‡æ’åº
2. å¤„ç†å™¨é‡æ’åº
3. å†…å­˜é‡æ’åº

## ç›®çš„
é‡æ’åºå­˜åœ¨çš„ç›®çš„æ˜¯ä¸ºäº†æ›´å¥½çš„æ‰§è¡Œæ€§èƒ½ä¼˜åŒ–
<!-- more -->
## å±éšœ
åç§°|å«ä¹‰|ä½œç”¨|å®ç°
:--:|:--:|:--:|:--:
loadLoad|load1; loadLoad; load2|æ‰€æœ‰çš„load2æ“ä½œéƒ½å‘ç”Ÿåœ¨|sfence
storeStore|store1; storeStore; store2;|æ‰€æœ‰çš„store1éƒ½åœ¨store2ä¹‹å‰|lfence
loadStore|load1; loadStore; store|æ‰€æœ‰çš„loadæ“ä½œå‘ç”Ÿåœ¨storeä¹‹å‰
storeLoad|store1; storeLoad; load1|æ‰€æœ‰çš„store1æ“ä½œå‘ç”Ÿåœ¨load1ä¹‹å‰|mfence
**tip:**
1. storeLoadæ˜¯å…¨èƒ½å‹å±éšœï¼Œä½†æ˜¯éœ€è¦åˆ·æ–°ç¼“å­˜ï¼Œæ€§èƒ½æŸè€—è¾ƒå¤§ã€‚
2. mfenceå’Œlockçš„åŒºåˆ«ï¼Œä½œç”¨ç±»ä¼¼ï¼Œä½†æ˜¯lockå¯èƒ½ä¼šé”ä½å†…å­˜æ€»çº¿ã€‚
3. MESIåè®®ï¼Œç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ŒstoreLoadéœ€è¦ã€‚   

# å†…å­˜ç»“æ„
![å¤„ç†å™¨å†…å­˜ç»“æ„](/images/å¤„ç†å™¨å†…å­˜.png)

# MESI
æ˜¯Cacheä¸€è‡´æ€§åè®®ï¼Œç¼“å­˜è¡Œé‡Œé¢æœ‰ä¸¤ä¸ªbitï¼Œè¡¨ç¤ºå½“å‰ç¼“å­˜è¡Œæ˜¯å¦æœ‰æ•ˆã€‚

çŠ¶æ€|æè¿°
:-|:-
Modified|æ•°æ®æœ‰æ•ˆï¼Œä½†æ˜¯å’Œå†…å­˜ä¸­çš„ä¸ä¸€è‡´
Exclusive|æ•°æ®æœ‰æ•ˆï¼Œå¹¶ä¸”åªæœ‰å½“å‰ä¸€ä¸ªå‰¯æœ¬
Shared|æ•°æ®æœ‰æ•ˆï¼Œä½†æ˜¯æœ‰å¤šä¸ªå‰¯æœ¬
Invalid|æ•°æ®æ— æ•ˆï¼Œéœ€è¦é‡æ–°ä»å†…å­˜è¯»å–

# longï¼Œdouble
jvmè§„èŒƒä¸­ï¼Œé’ˆå¯¹äºévolatileç±»å‹ä¿®é¥°çš„longï¼Œdoubleçš„å†™å…¥ï¼Œjmmæ˜¯åˆ†ä¸ºä¸¤æ¬¡32å­—èŠ‚æ“ä½œçš„ã€‚
ä½†æ˜¯åœ¨ç›®å‰çš„å•†ç”¨è™šæ‹Ÿæœºä¸­ï¼Œ64å­—èŠ‚çš„å†™å…¥æ“ä½œæ˜¯**åŸå­çš„**ï¼Œä¸éœ€è¦æ‹…å¿ƒæ­¤ç±»é—®é¢˜ã€‚

# volatile
## ä½œç”¨
ä¿è¯å¯è§æ€§ï¼Œä»¥åŠé˜²æ­¢é‡æ’åº
## åŸç†
```java
volatile int count = 0;

storeStore
count=10;
storeLoad // sfence

loadLoad
if (count > 10) {}
loadStore
```

# final
1. finalåŸŸçš„å†™å…¥æ“ä½œä¹‹åæ’å…¥äº†storeStoreï¼Œç¦æ­¢é‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ï¼Œ**ä¸ºäº†é˜²æ­¢å¯¹è±¡å¼•ç”¨é€ƒé€¸**
2. è¯»å¯¹è±¡çš„å¼•ç”¨å’Œå¯¹è±¡finalåŸŸæ“ä½œä¹‹é—´æ’å…¥loadLoadå±éšœï¼Œ**ä¸ºäº†é˜²æ­¢è¯»åˆ°æœªå®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡**

# synchronized
synchronizedä¹Ÿæ˜¯æœ‰åŒæ­¥ä½œç”¨å­˜åœ¨ï¼Œé€€å‡ºåŒæ­¥å—ä¹‹å‰ï¼Œä¼šæŠŠobjectå¯¹è±¡åˆ·æ–°å›ä¸»å†…å­˜ã€‚
```java
synchronized (object) {
}
```

# æ€è€ƒé¢˜
é—®: 
ä¸‹é¢çš„è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿ
ç­”:
è¾“å‡ºæ˜¯40000ã€‚
```java
public class VariableTest {
    static int count = 0;
    static int max = 20_000;

    public static void main(String[] args) throws InterruptedException {
        Thread thread1 = new Thread(() -> {
            for (int i = 0; i < max; i++) {
                while (System.currentTimeMillis() % 2 == 0)
                    Thread.yield();

                count += 1;
                LockSupport.parkNanos(1000_000);
            }
        });
        thread1.start();

        Thread thread2 = new Thread(() -> {
            for (int i = 0; i < max; i++) {
                while (System.currentTimeMillis() % 2 == 1)
                    Thread.yield();

                count += 1;
                LockSupport.parkNanos(1000_000);
            }
        });
        thread2.start();

        thread1.join();
        thread2.join();
        System.out.println(count);
    }
}
```