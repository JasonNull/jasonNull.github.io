---
title: RocketMQ笔记
date: 2018-06-24 16:14:37
tags: 
- 中间件
- rocketmq
categories:
- 中间件
---
#### 介绍
1. rocket来源于阿里中间件团队，前身是kafaka，改进了kafka在消息可靠性
2. kafka是linkedin公司为了收集日志开发的消息中间件，scala语言编写，吞吐量单机在100万左右
3. kafka吞吐量高的一个原因是是，客户端发送消息是会进行合并，将多个消息一起发送给服务端，服务端同时处理
4. 两个消息的写入都会同时使用页写入的策略，一次写入一页的消息，效率更高
<!-- more -->

#### 模式
1. 点对点，p2p
2. 发布/订阅，topic
ons上为集群模式，或者是广播模式，配置中心在广播模式之下

#### 概念
1. topic，用于区分消息的业务类型
2. queue，最大数量为4（可调整），从属于topic，消息是按照queue的维度来进行存储和发送的，每个消息都会归属于一个指定的queue（默认三种路由策略，随机，一致性hash，和机器随机
3. consumer，监听topic的应用
4. producer，生产指定消息的应用
5. consumer group，一组监听同一个topic的consumer的集合

#### 组件
1. nameserver，存储broker（主从），broker与topic信息（包含queue），topic与queue
2. broker，用于转发消息，一般每台broker上会有多个

#### 存储
1. consumeQueue，用于存储queue已经消费到那个message了，里面有针对commitLog的文件偏移量
2. commitLog，具体存储消息的地方，顺序存储，一次落盘，充分利用磁盘顺序读写（块设备）的特性

#### 消息可靠性
1. broker，主从同写，异步复制
2. 消费失败，会进入重试队列，重试16次，每次10秒

#### 怎么保证消息消费的顺序性
1. 自定义queue策略，将相同订单id的消息扔到相同队列中去

#### 接口幂等性
1. 使用消息队列需要保证接口的幂等性，如果消息已经被处理过，那就不应该再次被处理。
2. 如果消息重发，需要先查找上次处理的进度，然后继续业务逻辑