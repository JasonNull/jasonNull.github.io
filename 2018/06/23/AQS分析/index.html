<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>AQSåˆ†æ | é™ˆæ–Œçš„åšå®¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="CLHé˜Ÿåˆ—ç¤ºä¾‹123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172public class CLHLock &amp;#123;    @Data    class Node &amp;#123;">
<meta name="keywords" content="java,å¹¶å‘,æºç ">
<meta property="og:type" content="article">
<meta property="og:title" content="AQSåˆ†æ">
<meta property="og:url" content="http://yoursite.com/2018/06/23/AQSåˆ†æ/index.html">
<meta property="og:site_name" content="é™ˆæ–Œçš„åšå®¢">
<meta property="og:description" content="CLHé˜Ÿåˆ—ç¤ºä¾‹123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172public class CLHLock &amp;#123;    @Data    class Node &amp;#123;">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/CLH.jpg">
<meta property="og:image" content="http://yoursite.com/images/AQS.jpg">
<meta property="og:updated_time" content="2018-06-23T11:01:55.769Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AQSåˆ†æ">
<meta name="twitter:description" content="CLHé˜Ÿåˆ—ç¤ºä¾‹123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172public class CLHLock &amp;#123;    @Data    class Node &amp;#123;">
<meta name="twitter:image" content="http://yoursite.com/images/CLH.jpg">
  
    <link rel="alternate" href="/atom.xml" title="é™ˆæ–Œçš„åšå®¢" type="application/atom+xml">
  
  
    <link rel="icon" href="/css/images/favicon.png" type="image/x-icon">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">é™ˆæ–Œçš„åšå®¢</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">æŠ€æœ¯å®…çš„ç«™ç‚¹</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="æœç´¢"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
  <!-- <base target="_blank" /> -->
</header>
      <div class="outer">
        <section id="main"><article id="post-AQSåˆ†æ" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/23/AQSåˆ†æ/" class="article-date">
  <time datetime="2018-06-23T10:24:52.000Z" itemprop="datePublished">2018-06-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>â–º<a class="article-category-link" href="/categories/java/å¹¶å‘/">å¹¶å‘</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      AQSåˆ†æ
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
          <div id="toc" class="toc-article">
            <strong class="toc-title">æ–‡ç« ç›®å½•</strong>
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CLHé˜Ÿåˆ—"><span class="toc-number">1.</span> <span class="toc-text">CLHé˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ç¤ºä¾‹"><span class="toc-number">1.1.</span> <span class="toc-text">ç¤ºä¾‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#åŸç†"><span class="toc-number">1.2.</span> <span class="toc-text">åŸç†</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AQS"><span class="toc-number">2.</span> <span class="toc-text">AQS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#åŸç†-1"><span class="toc-number">2.1.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#é™æ€å±æ€§"><span class="toc-number">2.2.</span> <span class="toc-text">é™æ€å±æ€§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æˆå‘˜å±æ€§"><span class="toc-number">2.3.</span> <span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸»è¦æ–¹æ³•"><span class="toc-number">2.4.</span> <span class="toc-text">ä¸»è¦æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#å¯ä¸­æ–­ç­‰å¾…"><span class="toc-number">2.4.1.</span> <span class="toc-text">å¯ä¸­æ–­ç­‰å¾…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node"><span class="toc-number">2.4.2.</span> <span class="toc-text">Node</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hasQueuedPredecessors"><span class="toc-number">2.4.3.</span> <span class="toc-text">hasQueuedPredecessors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tryAcquire-acquire"><span class="toc-number">2.4.4.</span> <span class="toc-text">tryAcquire, acquire</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tryRelease-release"><span class="toc-number">2.4.5.</span> <span class="toc-text">tryRelease, release</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tryAcquireShared-acquireShared"><span class="toc-number">2.4.6.</span> <span class="toc-text">tryAcquireShared, acquireShared</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tryReleaseShared-releaseShared"><span class="toc-number">2.4.7.</span> <span class="toc-text">tryReleaseShared, releaseShared</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Condition"><span class="toc-number">2.4.8.</span> <span class="toc-text">Condition</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#è°ƒç”¨å…³ç³»"><span class="toc-number">2.5.</span> <span class="toc-text">è°ƒç”¨å…³ç³»</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ReentrantLock"><span class="toc-number">3.</span> <span class="toc-text">ReentrantLock</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#å…¬å¹³æ€§"><span class="toc-number">3.1.</span> <span class="toc-text">å…¬å¹³æ€§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sync"><span class="toc-number">3.2.</span> <span class="toc-text">Sync</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Semaphore"><span class="toc-number">4.</span> <span class="toc-text">Semaphore</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#å…¬å¹³æ€§-1"><span class="toc-number">4.1.</span> <span class="toc-text">å…¬å¹³æ€§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ç¼ºé™·"><span class="toc-number">4.2.</span> <span class="toc-text">ç¼ºé™·</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sync-1"><span class="toc-number">4.3.</span> <span class="toc-text">Sync</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CountDownLatch"><span class="toc-number">5.</span> <span class="toc-text">CountDownLatch</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Sync-2"><span class="toc-number">5.1.</span> <span class="toc-text">Sync</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CyclicBarrier"><span class="toc-number">6.</span> <span class="toc-text">CyclicBarrier</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#æ€è€ƒï¼šä¸ºä»€ä¹ˆä¸åŸºäºAQSå®ç°"><span class="toc-number">6.1.</span> <span class="toc-text">æ€è€ƒï¼šä¸ºä»€ä¹ˆä¸åŸºäºAQSå®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æˆå‘˜å±æ€§-1"><span class="toc-number">6.2.</span> <span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸»è¦æ–¹æ³•-1"><span class="toc-number">6.3.</span> <span class="toc-text">ä¸»è¦æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#doAwait"><span class="toc-number">6.3.1.</span> <span class="toc-text">doAwait</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reset"><span class="toc-number">6.3.2.</span> <span class="toc-text">reset</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ReadWriteLock"><span class="toc-number">7.</span> <span class="toc-text">ReadWriteLock</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å†™é”é™çº§"><span class="toc-number">7.0.0.1.</span> <span class="toc-text">å†™é”é™çº§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#è¯»é”å‡çº§"><span class="toc-number">7.0.0.2.</span> <span class="toc-text">è¯»é”å‡çº§</span></a></li></ol></li></ol></li></ol></li></ol>
          </div>
        
        <h1 id="CLHé˜Ÿåˆ—"><a href="#CLHé˜Ÿåˆ—" class="headerlink" title="CLHé˜Ÿåˆ—"></a>CLHé˜Ÿåˆ—</h1><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CLHLock</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> locking;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> lockedCount;</span><br><span class="line"></span><br><span class="line">        Node() &#123;</span><br><span class="line">            lockedCount = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AtomicReference&lt;Node&gt; tail;</span><br><span class="line">    <span class="keyword">private</span> ThreadLocal&lt;Node&gt; myself = ThreadLocal.withInitial(() -&gt; <span class="keyword">new</span> Node());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CLHLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        tail = <span class="keyword">new</span> AtomicReference&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node current = myself.get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (current.locking) &#123;</span><br><span class="line">            ++current.lockedCount;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            current.locking = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Node previous = tail.getAndSet(current);</span><br><span class="line">        <span class="keyword">while</span> (previous != <span class="keyword">null</span> &amp;&amp; previous.locking) &#123;</span><br><span class="line">            Thread.yield();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node current = myself.get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (--current.lockedCount == <span class="number">0</span>) &#123;</span><br><span class="line">            current.locking = <span class="keyword">false</span>;</span><br><span class="line">            myself.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">int</span> max = <span class="number">1000000</span>;</span><br><span class="line">        CLHLock clhLock = <span class="keyword">new</span> CLHLock();</span><br><span class="line"></span><br><span class="line">        Stopwatch stopwatch = Stopwatch.createStarted();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; max; i++) &#123;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                clhLock.lock();</span><br><span class="line">                clhLock.lock();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (count % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                    System.out.println(count);</span><br><span class="line">                &#125;</span><br><span class="line">                ++count;</span><br><span class="line"></span><br><span class="line">                clhLock.unlock();</span><br><span class="line">                clhLock.unlock();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (count != max) ;</span><br><span class="line">        executorService.shutdownNow();</span><br><span class="line">        System.out.println(<span class="string">"lock is right, count: "</span> + count);</span><br><span class="line">        System.out.println(<span class="string">"used time: "</span> + stopwatch.elapsed());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p><img src="/images/CLH.jpg" alt="åŠ é”è§£é”ç¤ºæ„å›¾"></p>
<h1 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h1><h2 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h2><ol>
<li>æ•°æ®ç»“æ„ç­‰å¾…é“¾è¡¨ï¼Œä½¿ç”¨çš„æ˜¯å°¾æ’æ³•</li>
<li>Lockç­‰æ–¹æ³•ï¼Œéƒ½æ˜¯ä¸ä¼šä¸»åŠ¨æŠ›å‡º<code>InterruptedException</code>çš„ï¼Œé™¤éè°ƒç”¨å¯ä¸­æ–­ç‰ˆæœ¬</li>
</ol>
<p><img src="/images/AQS.jpg" alt="AQSåŸç†"></p>
<h2 id="é™æ€å±æ€§"><a href="#é™æ€å±æ€§" class="headerlink" title="é™æ€å±æ€§"></a>é™æ€å±æ€§</h2><ol>
<li><code>long spinForTimeoutThreshold = 1000L</code>ï¼Œè¶…è¿‡æ­¤æ—¶é—´å°†ä¼šé‡‡ç”¨LockSupport.parkNanos()ï¼Œè€Œä¸æ˜¯è‡ªæ—‹</li>
</ol>
<h2 id="æˆå‘˜å±æ€§"><a href="#æˆå‘˜å±æ€§" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h2><ol>
<li><code>volatile Node head</code>ï¼Œé“¾è¡¨çš„å¤´ç»“ç‚¹ï¼Œå‚€å„¡èŠ‚ç‚¹ï¼ˆprevï¼Œthreadå±æ€§éƒ½ä¸ºç©ºï¼‰</li>
<li><code>volatile Node tail</code>ï¼Œé“¾è¡¨çš„å°¾ç»“ç‚¹ï¼Œ</li>
<li><code>volatile int state</code>ï¼ŒçŠ¶æ€å˜é‡ï¼Œç”¨äºæ§åˆ¶è·å–çš„</li>
</ol>
<h2 id="ä¸»è¦æ–¹æ³•"><a href="#ä¸»è¦æ–¹æ³•" class="headerlink" title="ä¸»è¦æ–¹æ³•"></a>ä¸»è¦æ–¹æ³•</h2><h3 id="å¯ä¸­æ–­ç­‰å¾…"><a href="#å¯ä¸­æ–­ç­‰å¾…" class="headerlink" title="å¯ä¸­æ–­ç­‰å¾…"></a>å¯ä¸­æ–­ç­‰å¾…</h3><ol>
<li><code>LockSupport.park()</code>ä¼šä»<code>Thread.interrupt()</code>ä¸­è¢«å”¤é†’</li>
<li>æ·»åŠ <code>Thread.interrupted()</code>æ£€æµ‹</li>
</ol>
<p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•å®ç°ä¸­æ–­çš„ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Node node = addWaiter(Node.EXCLUSIVE);</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><ol>
<li><code>int waitStatus</code>ï¼Œå½“å‰èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€<ul>
<li>SIGNALï¼Œä»£è¡¨å½“å‰èŠ‚ç‚¹éœ€è¦è¢«å”¤é†’</li>
<li>CANCELLEDï¼Œä»£è¡¨å½“å‰èŠ‚ç‚¹å·²ç»è¢«å–æ¶ˆ</li>
<li>CONDITIONï¼Œä»£è¡¨å½“å‰èŠ‚ç‚¹åœ¨ç­‰å¾…ä¸€ä¸ªæ¡ä»¶</li>
<li>PROPAGATEï¼Œä»£è¡¨å½“å‰èŠ‚ç‚¹æ­£åœ¨è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œï¼Œå¹¶ä¸”æ˜¯sharedæ–¹å¼è·å–ï¼Œéœ€è¦å‘åä¼ æ’­</li>
<li>0ï¼Œä»£è¡¨å½“å‰èŠ‚ç‚¹æ­£å¸¸ï¼Œæ²¡æœ‰ä»»ä½•æ“ä½œè¿›è¡Œ</li>
</ul>
</li>
<li><code>Node prev</code>ï¼Œå‰ä¸€ä¸ªèŠ‚ç‚¹</li>
<li><code>Node next</code>ï¼Œåä¸€ä¸ªèŠ‚ç‚¹</li>
<li><code>Thread thread</code>ï¼Œç­‰å¾…çš„çº¿ç¨‹</li>
<li><code>Node nextWaiter</code>ï¼Œä¸‹ä¸€ä¸ªConditioné“¾è¡¨ä¸­çš„èŠ‚ç‚¹ï¼Œæˆ–è€…è¡¨ç¤ºå½“å‰æ˜¯å¦åœ¨ç‹¬å æ¨¡å¼ç­‰å¾…</li>
</ol>
<h3 id="hasQueuedPredecessors"><a href="#hasQueuedPredecessors" class="headerlink" title="hasQueuedPredecessors"></a>hasQueuedPredecessors</h3><p><strong>è¿™ä¸ªæ–¹æ³•é‡ä¸­ä¹‹é‡ï¼Œç”¨äºåˆ¤æ–­å…¬å¹³æ€§</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨äºåˆ¤æ–­ç­‰å¾…é“¾ä¸­çš„ç¬¬ä¸€ä¸ªç­‰å¾…çº¿ç¨‹æ˜¯ä¸æ˜¯è‡ªå·±</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasQueuedPredecessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node t = tail; </span><br><span class="line">    Node h = head;</span><br><span class="line">    Node s;</span><br><span class="line">    <span class="keyword">return</span> h != t </span><br><span class="line">        &amp;&amp; ((s = h.next) == <span class="keyword">null</span> </span><br><span class="line">             || s.thread != Thread.currentThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="tryAcquire-acquire"><a href="#tryAcquire-acquire" class="headerlink" title="tryAcquire, acquire"></a>tryAcquire, acquire</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‘˜è‡ªäºReentrantLockçš„FairSync</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœé”æ²¡æœ‰è¢«åŠ é”</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// ä¸å­˜åœ¨å‰é©±èŠ‚ç‚¹ï¼Œå¹¶ä¸”æˆåŠŸè·å–äº†è®¸å¯</span></span><br><span class="line">        <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">            compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            <span class="comment">// å°†å½“å‰çº¿ç¨‹è®¾ç½®ä¸ºæ‹¥æœ‰è€…</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹æ˜¯æ‹¥æœ‰è€…</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="comment">// å°è¯•æ›´æ–°æ‹¥æœ‰è®¸å¯è®¡æ•°</span></span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æŸ¥çœ‹ä¸Šä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">int</span> ws = pred.waitStatus;</span><br><span class="line">    <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯SIGNAL</span></span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// å¯»æ‰¾åˆ°ä¸Šä¸ªåœ¨ç­‰å¾…çš„èŠ‚ç‚¹ï¼Œæˆ–è€…æ˜¯å·²ç»è·å–é”çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ›´æ”¹ä¸Šä¸ªèŠ‚ç‚¹çŠ¶æ€ï¼Œä¾¿äºåç»­çš„åˆ¤æ–­</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿›å…¥é˜»å¡ï¼Œç­‰å¾…è¢«å”¤é†’</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–è®¸å¯</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼Œå¹¶ä¸”è·å–æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">// é‡æ–°è®¾ç½®å¤´ç»“ç‚¹</span></span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// è¿”å›æ˜¯å¦è¢«ä¸­æ–­</span></span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// éœ€è¦ç­‰å¾…ï¼ˆä¸Šä¸ªæœ‰æ•ˆèŠ‚ç‚¹ä¸æ˜¯å¤´ç»“ç‚¹)</span></span><br><span class="line">            <span class="comment">// å¹¶ä¸”å°è¯•ç­‰å¾…</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) </span><br><span class="line">                    &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå¼‚å¸¸ç»ˆæ­¢ï¼Œåˆ™å–æ¶ˆå½“å‰è·å–</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°è¯•è·å–ï¼Œä¸æˆåŠŸåˆ™è¿›å…¥é˜»å¡è·å–é˜¶æ®µ</span></span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg)</span><br><span class="line">            &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å”¤é†’é“¾è¡¨ä¸­æœ€å‰é¢çš„ç­‰å¾…çº¿ç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å–æ¶ˆè·å–ï¼Œå¹¶ä¸”è®¾ç½®çŠ¶æ€</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAcquire</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    node.thread = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·³è¿‡è¢«å–æ¶ˆçš„èŠ‚ç‚¹</span></span><br><span class="line">    Node pred = node.prev;</span><br><span class="line">    <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line"></span><br><span class="line">    Node predNext = pred.next;</span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹çŠ¶æ€è¢«è®¾ç½®ä¸ºå–æ¶ˆ</span></span><br><span class="line">    node.waitStatus = Node.CANCELLED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯å°¾ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">        compareAndSetNext(pred, predNext, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> ws;</span><br><span class="line">        <span class="comment">// å¦‚æœå‰é¢çš„èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// å¹¶ä¸”åœ¨ç­‰å¾…å”¤é†’ï¼ˆSIGNALï¼ŒPROPAGATEï¼ŒCONDITIONï¼‰ï¼Œçº¿ç¨‹ä¸ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">            ((ws = pred.waitStatus) == Node.SIGNAL </span><br><span class="line">                || (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) </span><br><span class="line">                &amp;&amp; pred.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Node next = node.next;</span><br><span class="line">            <span class="comment">// ä»é“¾è¡¨ä¸­åˆ é™¤å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                compareAndSetNext(pred, predNext, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ç›´æ¥å”¤é†’å¾…å–æ¶ˆèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            unparkSuccessor(node);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°†å½“å‰èŠ‚ç‚¹è„±é“¾</span></span><br><span class="line">        node.next = node;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="tryRelease-release"><a href="#tryRelease-release" class="headerlink" title="tryRelease, release"></a>tryRelease, release</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReentrantLockçš„é‡Šæ”¾</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// å¯é‡å…¥é”çš„è®¡æ•°ï¼Œè®¡æ•°ä¸º0ï¼Œä»£è¡¨ï¼Œå·²ç»é‡Šæ”¾æ‰€æœ‰è®¸å¯</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="keyword">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// å”¤é†’ä¸‹ä¸€ä¸ªç­‰å¾…çº¿ç¨‹</span></span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="tryAcquireShared-acquireShared"><a href="#tryAcquireShared-acquireShared" class="headerlink" title="tryAcquireShared, acquireShared"></a>tryAcquireShared, acquireShared</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Semaphoreçš„è·å–</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">        <span class="keyword">int</span> available = getState();</span><br><span class="line">        <span class="keyword">int</span> left = available - arg;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¸å¯ä¸è¶³ï¼Œæˆ–è€…è·å–æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (left &lt; <span class="number">0</span> || compareAndSetState(available, left)) &#123;</span><br><span class="line">            <span class="keyword">return</span> left;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å…±äº«æ–¹å¼è·å–è®¸å¯</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// å°è¯•é˜»å¡è·å–</span></span><br><span class="line">        doAcquireShared(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setHeadAndPropagate</span><span class="params">(Node node, <span class="keyword">int</span> propagate)</span> </span>&#123;</span><br><span class="line">    Node h = head; <span class="comment">// Record old head for check below</span></span><br><span class="line">    setHead(node);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿è¯ä¼ æ’­æ€§ï¼Œå¦‚æœä¸‹ä¸ªèŠ‚ç‚¹ä¹Ÿåœ¨ç­‰å¾…</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="keyword">null</span> || h.waitStatus &lt; <span class="number">0</span> </span><br><span class="line">            || (h = head) == <span class="keyword">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        Node s = node.next;</span><br><span class="line">        <span class="comment">// ä¸‹ä¸ªèŠ‚ç‚¹æ˜¯å…±äº«èŠ‚ç‚¹ï¼Œå”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å»è·å–è®¸å¯</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.isShared())</span><br><span class="line">            doReleaseShared();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¦ç‚¹æ˜¯è·å–è®¸å¯æˆåŠŸä¹‹åï¼Œè¿˜ä¼šå”¤é†’ä¸‹ä¸€ä¸ªç­‰å¾…çº¿ç¨‹å»å°è¯•è·å–</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æŠŠå½“å‰çº¿ç¨‹æ·»åŠ åˆ°ç­‰å¾…é“¾å½“ä¸­</span></span><br><span class="line">    <span class="keyword">final</span> Node node = addWaiter(Node.SHARED);</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="comment">// å‰é¢æ²¡æœ‰ä»»ä½•çº¿ç¨‹ç­‰å¾…s</span></span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="comment">// å°è¯•å†æ¬¡è·å–</span></span><br><span class="line">                <span class="keyword">int</span> r = tryAcquireShared(arg);</span><br><span class="line">                <span class="comment">// è·å–æˆåŠŸ</span></span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// æ›´æ–°å¤´ç»“ç‚¹ï¼Œå¹¶ä¸”å°è¯•å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    <span class="keyword">if</span> (interrupted)</span><br><span class="line">                        selfInterrupt();</span><br><span class="line">                    failed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é˜»å¡è‡ªå·±</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="tryReleaseShared-releaseShared"><a href="#tryReleaseShared-releaseShared" class="headerlink" title="tryReleaseShared, releaseShared"></a>tryReleaseShared, releaseShared</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="comment">// Semaphoreçš„å°è¯•é‡Šæ”¾</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾ï¼Œæ­»å¾ªç¯ï¼ŒçŸ¥é“é™ˆå®«</span></span><br><span class="line">    <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">        <span class="keyword">int</span> available = getState();</span><br><span class="line">        <span class="keyword">int</span> left = available + arg;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (left &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"maximum limits get"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (compareAndSetState(available, left)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">releaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°è¯•é‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å”¤é†’ä¸‹ä¸€ä¸ªç­‰å¾…çº¿ç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReleaseShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="comment">// å¤´ç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">int</span> ws = h.waitStatus;</span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="comment">// æ›´æ–°å¤´ç»“ç‚¹çŠ¶æ€ä¸º0</span></span><br><span class="line">                <span class="comment">// è¿™ä¸ªè‡ªæ—‹æ˜¯ä¸ºäº†ä¿è¯é‡Šæ”¾çš„èŠ‚ç‚¹æ˜¯éœ€è¦è¢«å”¤é†’çš„èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="comment">// å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯ä¸ºäº†ä¿è¯ä¼ æ’­æ€§</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œé‡Šæ”¾è®¸å¯æ“ä½œï¼Œç»§ç»­</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp; !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœé‡Šæ”¾æˆåŠŸä¸€ä¸ªèŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">        <span class="keyword">if</span> (h == head) </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h3><p>å¦‚ä¸Šé¢çš„å›¾è¡¨ç¤ºçš„ï¼ŒConditionå†…éƒ¨å«æœ‰ä¸€ä¸ªé“¾è¡¨ä¸‹é¢æ˜¯awaitå’Œsignalçš„ç®€ä»‹ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="comment">// åŠ å…¥Conditionç­‰å¾…é“¾è¡¨</span></span><br><span class="line">    Node node = addConditionWaiter();</span><br><span class="line">    <span class="keyword">int</span> savedState = fullyRelease(node);</span><br><span class="line">    <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å½“å‰åœ¨ç­‰å¾…Condition</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰çº¿ç¨‹è¢«è°ƒç”¨signalå”¤é†’</span></span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// å½“å‰çº¿ç¨‹è¢«ä¸­æ–­</span></span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å½“å‰çº¿ç¨‹æ²¡è¢«ä¸­æ–­çš„è¯ï¼Œå°è¯•ä»¥ç‹¬å æ¨¡å¼è·å–è®¸å¯ </span></span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line">    <span class="comment">// å°è¯•åˆ é™¤è¢«å–æ¶ˆçš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>) <span class="comment">// clean up if cancelled</span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">    <span class="comment">// æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// æ£€æµ‹æ˜¯å¦ç‹¬å æ¨¡å¼è·å–</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    Node first = firstWaiter;</span><br><span class="line">    <span class="comment">// å”¤é†’é“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignal</span><span class="params">(Node first)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="keyword">null</span>)</span><br><span class="line">            lastWaiter = <span class="keyword">null</span>;</span><br><span class="line">        first.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp;</span><br><span class="line">                (first = firstWaiter) != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å½“å‰èŠ‚ç‚¹ä»Conditionä¸­è„±é“¾ï¼ŒåŠ å…¥åˆ°AQSçš„é“¾è¡¨ä¸­ï¼ˆå¤ç”¨äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferForSignal</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å·²ç»è¢«å–æ¶ˆ</span></span><br><span class="line">    <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å½“å‰èŠ‚ç‚¹ä»Conditionçš„ç­‰å¾…é˜Ÿåˆ—è½¬ç§»åˆ°AQSçš„ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    Node p = enq(node);</span><br><span class="line">    <span class="keyword">int</span> ws = p.waitStatus;</span><br><span class="line">    <span class="comment">// å°†èŠ‚ç‚¹çŠ¶æ€ï¼Œæ”¹æˆSIGNAL</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        <span class="comment">// å”¤é†’èŠ‚ç‚¹çš„ç­‰å¾…çº¿ç¨‹</span></span><br><span class="line">        LockSupport.unpark(node.thread);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="è°ƒç”¨å…³ç³»"><a href="#è°ƒç”¨å…³ç³»" class="headerlink" title="è°ƒç”¨å…³ç³»"></a>è°ƒç”¨å…³ç³»</h2><p>acquireå…ˆè°ƒç”¨tryAcquireï¼Œ<strong>ä¸æˆåŠŸ</strong>ï¼Œè°ƒç”¨doAcquire()é˜»å¡ç­‰å¾…<br>releaseå…ˆè°ƒç”¨tryReleaseï¼Œ<strong>æˆåŠŸäº†</strong>ï¼Œè°ƒç”¨doRelease()é‡Šæ”¾ä¸‹ä¸€ä¸ªç­‰å¾…çº¿ç¨‹</p>
<hr>
<h1 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h1><p>å†…éƒ¨ä¸€ä¸ªSyncç±»ï¼Œç»§æ‰¿äº†AQSç”¨äºå®ç°ç‹¬å é”çš„åŠŸèƒ½ï¼Œä¸»è¦æ˜¯å®ç°äº†tryAcquireå’ŒtryReleaseåŠŸèƒ½</p>
<h2 id="å…¬å¹³æ€§"><a href="#å…¬å¹³æ€§" class="headerlink" title="å…¬å¹³æ€§"></a>å…¬å¹³æ€§</h2><p>ç”±<code>hasQueuedPredecessors()</code>æ¥ä¿è¯çš„ï¼Œå¦‚æœå­˜åœ¨å‰ç½®èŠ‚ç‚¹ï¼Œåˆ™è¿”å›å°è¯•åŠ é”å¤±è´¥</p>
<h2 id="Sync"><a href="#Sync" class="headerlink" title="Sync"></a>Sync</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">5179523762034025860L</span>;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="comment">// è¿˜æœªåŠ é”</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å½“å‰çº¿ç¨‹æ˜¯æ‹¥æœ‰è€…çº¿ç¨‹ï¼Œæ­¤æ¬¡æ˜¯é‡å…¥åŠ é”</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="comment">// å¤šæ¬¡åŠ é”</span></span><br><span class="line">            <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">        <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// ç”¨äºä¿è¯å¤šæ¬¡é‡Šæ”¾</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            free = <span class="keyword">true</span>;</span><br><span class="line">            setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setState(c);</span><br><span class="line">        <span class="keyword">return</span> free;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> ConditionObject <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConditionObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// éå…¬è¯„é”ï¼Œç›´æ¥åŠ é”ï¼ˆè¢«å”¤é†’çš„çº¿ç¨‹è¿˜æœªå¾—åˆ°æ—¶é—´ç‰‡è¿è¡Œï¼Œç­‰è¿è¡Œæ—¶ä¼šè¿›è¡Œå†æ¬¡ä¹¦é¢ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3000897897090466540L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å…¬å¹³æ€§é‡ç‚¹!!!!!!!!</span></span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‡å¤åŠ é”</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h1><p>åŸºæœ¬å’ŒReentrantLockä¸€æ ·ï¼Œä¸»è¦å®ç°äº†tryAcquiredShared()å’ŒtryReleaseShared()ã€‚</p>
<h2 id="å…¬å¹³æ€§-1"><a href="#å…¬å¹³æ€§-1" class="headerlink" title="å…¬å¹³æ€§"></a>å…¬å¹³æ€§</h2><p>ç”±<code>hasQueueProdecessors()</code>æ¥å†³å®šçš„ï¼Œå¦‚æœå­˜åœ¨å‰ç½®èŠ‚ç‚¹å°±å¤±è´¥</p>
<h2 id="ç¼ºé™·"><a href="#ç¼ºé™·" class="headerlink" title="ç¼ºé™·"></a>ç¼ºé™·</h2><p>ç”±äºé˜Ÿåˆ—æ˜¯FIFOçš„ç»“æ„ï¼Œå¯¼è‡´äº†å¦‚æœé¦–å…ƒç»“ç‚¹è·å–å¤±è´¥ï¼Œåˆ™ä¸ä¼šå‘åä¼ æ’­ï¼Œä¸‹é¢æ˜¯ä¾‹å­<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œå°è¯•è·å–11ä¸ªè®¸å¯ï¼Œä½†æ˜¯ç”±äºè·å–å¤±è´¥ï¼Œä¸€ç›´ä¼šé˜»å¡ã€‚</span></span><br><span class="line"><span class="comment">// ç¬¬äºŒä¸ªå¯åŠ¨åï¼Œç”±äºå…¬å¹³æ€§åŸå› ï¼Œè·å–ç›´æ¥å¤±è´¥ï¼Œå¯¼è‡´ç›´æ¥å…¥é˜Ÿï¼Œæ­¤æ—¶å¦‚æœé˜Ÿåˆ—å¤´éƒ¨ä¸€ç›´è·å–å¤±è´¥çš„è¯ï¼Œé˜Ÿåˆ—æ˜¯ä¸èƒ½æœ‰ä»»ä½•å…ƒç´ å‡ºé˜Ÿçš„ã€‚</span></span><br><span class="line">Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">10</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123; semaphore.acquire(<span class="number">11</span>); semaphore.release(<span class="number">11</span>); &#125;).start();</span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123; semaphore.acquire(<span class="number">1</span>), semaphore.release(<span class="number">1</span>); &#125;).start();</span><br></pre></td></tr></table></figure></p>
<h2 id="Sync-1"><a href="#Sync-1" class="headerlink" title="Sync"></a>Sync</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">nonfairTryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å°è¯•å»è·å–ï¼Œä¸å¤„ç†æœ‰çº¿ç¨‹ç­‰å¾…çš„æƒ…å†µ</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">int</span> available = getState();</span><br><span class="line">            <span class="keyword">int</span> remaining = available - acquires;</span><br><span class="line">            <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> </span><br><span class="line">                    || compareAndSetState(available, remaining))</span><br><span class="line">                <span class="keyword">return</span> remaining;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ©ç”¨æ­»å¾ªç¯å»é‡Šæ”¾ï¼ŒçŸ¥é“é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">int</span> current = getState();</span><br><span class="line">            <span class="keyword">int</span> next = current + releases;</span><br><span class="line">            <span class="keyword">if</span> (next &lt; current) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum permit count exceeded"</span>);</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(current, next))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquireShared(acquires);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// å…¬å¹³æ€§é‡ç‚¹</span></span><br><span class="line">            <span class="comment">// å·²ç»æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œç›´æ¥å¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (hasQueuedPredecessors())</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">int</span> available = getState();</span><br><span class="line">            <span class="keyword">int</span> remaining = available - acquires;</span><br><span class="line">            <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">                    compareAndSetState(available, remaining))</span><br><span class="line">                <span class="keyword">return</span> remaining;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h1><p>ä¸å¯ä»¥<strong>è¢«é‡ç½®</strong>ï¼Œå¹¶ä¸ä»£è¡¨æŠ€æœ¯ä¸Šåšä¸åˆ°ï¼Œåªæ˜¯CountDownLatchå°±æ˜¯ç”¨æ¥ç”¨äºä¸€æ¬¡æ€§ä»»åŠ¡çš„ï¼Œæ”¯æŒé‡ç½®çš„è¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤šç»„è·å–ç´Šä¹±ã€‚</p>
<h2 id="Sync-2"><a href="#Sync-2" class="headerlink" title="Sync"></a>Sync</h2><p>å†…éƒ¨ä½¿ç”¨stateä½œä¸ºåˆå§‹è®¡æ•°ï¼Œæ¯æ¬¡è·å–åˆ™è®¡æ•°å‡ä¸€ï¼Œåˆ°è·å–å®Œåç›´æ¥æ˜¯é‡Šæ”¾æ‰€æœ‰çº¿ç¨‹<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è¿™æ‹›å¤ªæŸäº†</span></span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        <span class="keyword">return</span> (getState() == <span class="number">0</span>) ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Decrement count; signal when transition to zero</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">int</span> c = getState();</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">int</span> nextc = c-<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">                <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<h1 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h1><h2 id="æ€è€ƒï¼šä¸ºä»€ä¹ˆä¸åŸºäºAQSå®ç°"><a href="#æ€è€ƒï¼šä¸ºä»€ä¹ˆä¸åŸºäºAQSå®ç°" class="headerlink" title="æ€è€ƒï¼šä¸ºä»€ä¹ˆä¸åŸºäºAQSå®ç°"></a>æ€è€ƒï¼šä¸ºä»€ä¹ˆä¸åŸºäºAQSå®ç°</h2><p>æ²¡æœ‰åŠæ³•å•çº¯çš„åªåŸºäºAQSå°±å®ç°ï¼Œ<strong>éœ€è¦æ·»åŠ æ§åˆ¶å˜é‡</strong>ã€‚</p>
<h2 id="æˆå‘˜å±æ€§-1"><a href="#æˆå‘˜å±æ€§-1" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h2><ol>
<li><code>final ReentrantLock lock = new ReentrantLock();</code>ï¼Œç”¨äºä¿æŠ¤awaitæ“ä½œ</li>
<li><code>final Condition trip = lock.newCondition();</code>ç”¨äºç­‰å¾…è¢«å”¤é†’</li>
<li><code>final int parties;</code>æœ€å¤šæ”¯æŒçš„çº¿ç¨‹æ•°é‡</li>
<li><code>final Runnable barrierCommand;</code>barrierè¢«æ‰“ç ´æ—¶æ‰§è¡Œçš„å‘½ä»¤</li>
<li><code>Generation generation = new Generation();</code>ä»£è¡¨å½“å‰barrierçš„çŠ¶æ€</li>
<li><code>int count;</code><strong>æ²¡æœ‰volatile</strong>ï¼Œä¸ºä»€ä¹ˆä¸ç”¨volatileï¼Œcountåªåœ¨doAwait()æ–¹æ³•å†…éƒ¨è®¿é—®ï¼Œè€ŒdoAwaitæ˜¯å…¨ç¨‹åŠ é”çš„ï¼Œä¹Ÿå°±æ˜¯ä»£è¡¨countçš„è®¿é—®æ°¸è¿œéƒ½æ˜¯å•çº¿ç¨‹çš„è®¿é—®ã€‚</li>
</ol>
<h2 id="ä¸»è¦æ–¹æ³•-1"><a href="#ä¸»è¦æ–¹æ³•-1" class="headerlink" title="ä¸»è¦æ–¹æ³•"></a>ä¸»è¦æ–¹æ³•</h2><h3 id="doAwait"><a href="#doAwait" class="headerlink" title="doAwait"></a>doAwait</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤„ç†å‡ ç§å¼‚å¸¸</span></span><br><span class="line"><span class="comment">// 1. è¶…æ—¶</span></span><br><span class="line"><span class="comment">// 2. è¢«ä¸­æ–­</span></span><br><span class="line"><span class="comment">// 3. æ‰§è¡Œcommandæ—¶å¼‚å¸¸</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">dowait</span><span class="params">(<span class="keyword">boolean</span> timed, <span class="keyword">long</span> nanos)</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException, TimeoutException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Generation g = generation;</span><br><span class="line">        <span class="comment">// å¦‚æœå±éšœå·²ç»è§£é™¤ï¼Œè¿™ä¸ªç…§ç†æ¥è¯´ä¸å¯èƒ½å‘ç”Ÿçš„</span></span><br><span class="line">        <span class="comment">// é™¤éæŸä¸ªçº¿ç¨‹è¢«ä¸­æ–­äº†ï¼Œå¹¶ä¸”å”¤é†’äº†æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (g.broken)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BrokenBarrierException();</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            breakBarrier();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> index = --count;</span><br><span class="line">        <span class="comment">// indexä¸º0ï¼Œä»£è¡¨éœ€è¦è§£é™¤å±éšœ</span></span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;  <span class="comment">// tripped</span></span><br><span class="line">            <span class="keyword">boolean</span> ranAction = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// è¿è¡Œå‘½ä»¤</span></span><br><span class="line">                <span class="keyword">final</span> Runnable command = barrierCommand;</span><br><span class="line">                <span class="keyword">if</span> (command != <span class="keyword">null</span>)</span><br><span class="line">                    command.run();</span><br><span class="line">                ranAction = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">// å°†æ‰€æœ‰çº¿ç¨‹å”¤é†’ï¼Œå¹¶ä¸”æ›´æ–°generationï¼Œä½†æ˜¯ä¸æ›´æ–°count</span></span><br><span class="line">                nextGeneration();</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// è¿è¡Œcommandè¿‡ç¨‹å‡ºé”™</span></span><br><span class="line">                <span class="keyword">if</span> (!ranAction)</span><br><span class="line">                    breakBarrier();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è¶…æ—¶ç­‰å¾…ï¼Œå¹¶ä¸”å¤„ç†è¢«ä¸­æ–­çš„æƒ…å†µ</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!timed)</span><br><span class="line">                    trip.await();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nanos &gt; <span class="number">0L</span>)</span><br><span class="line">                    nanos = trip.awaitNanos(nanos);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                <span class="keyword">if</span> (g == generation &amp;&amp; ! g.broken) &#123;</span><br><span class="line">                    breakBarrier();</span><br><span class="line">                    <span class="keyword">throw</span> ie;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (g.broken)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BrokenBarrierException();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (g != generation)</span><br><span class="line">                <span class="comment">// è¿”å›å½“å‰çº¿ç¨‹çš„ç­‰å¾…åºå·</span></span><br><span class="line">                <span class="keyword">return</span> index;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                breakBarrier();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ„å»ºæ–°çš„å±éšœ</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">nextGeneration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    trip.signalAll();</span><br><span class="line">    count = parties;</span><br><span class="line">    generation = <span class="keyword">new</span> Generation();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…é™¤å½“å‰å±éšœ</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">breakBarrier</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    generation.broken = <span class="keyword">true</span>;</span><br><span class="line">    count = parties;</span><br><span class="line">    trip.signalAll();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        breakBarrier();</span><br><span class="line">        nextGeneration();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ReadWriteLock"><a href="#ReadWriteLock" class="headerlink" title="ReadWriteLock"></a>ReadWriteLock</h1><p>å†…éƒ¨åŸç†æ˜¯stateçŠ¶æ€å˜é‡çš„ä½16ä½ä»£è¡¨å†™é”æ•°é‡ï¼Œé«˜16ä½ä»£è¡¨è¯»é”æ•°é‡ã€‚<br><code>ReadLock.lock()</code>è°ƒç”¨<code>tryAcquireShared</code><br><code>WriteLock.lock()</code>è°ƒç”¨<code>tryAcquire</code></p>
<h4 id="å†™é”é™çº§"><a href="#å†™é”é™çº§" class="headerlink" title="å†™é”é™çº§"></a>å†™é”é™çº§</h4><p>åŸç†æ˜¯å…ˆè·å–è¯»é”ï¼ˆç›´æ¥è·å–ä¼šæˆåŠŸï¼‰ï¼Œé‡Šæ”¾å†™é”ï¼ˆåŒæ—¶è™½ç„¶ä¼šå”¤é†’å¤´ç­‰å¾…çº¿ç¨‹ï¼Œä½†æ˜¯æ²¡æœ‰ç”¨ï¼Œè·å–ä¸åˆ°ï¼‰</p>
<h4 id="è¯»é”å‡çº§"><a href="#è¯»é”å‡çº§" class="headerlink" title="è¯»é”å‡çº§"></a>è¯»é”å‡çº§</h4><p>ç›´æ¥åŠ å†™é”å‘—</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/23/AQSåˆ†æ/" data-id="cjiskaxko0000z2v8x86ao5n9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/å¹¶å‘/">å¹¶å‘</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/æºç /">æºç </a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/06/23/Atomicåˆ†æ/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Atomicåˆ†æ
        
      </div>
    </a>
  
  
    <a href="/2018/06/23/ThreadPoolExecutoråˆ†æ/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">ThreadPoolExecutoråˆ†æ</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">åˆ†ç±»</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">32</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/java/jvm/">jvm</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/åŸºç¡€/">åŸºç¡€</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/å¤šçº¿ç¨‹/">å¤šçº¿ç¨‹</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/å¹¶å‘/">å¹¶å‘</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/é›†åˆ/">é›†åˆ</a><span class="category-list-count">5</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/ä¸­é—´ä»¶/">ä¸­é—´ä»¶</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/åˆ†å¸ƒå¼/">åˆ†å¸ƒå¼</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/åˆ†å¸ƒå¼/å¾®æœåŠ¡/">å¾®æœåŠ¡</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/éšç¬”/">éšç¬”</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">æ ‡ç­¾</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/cms/">cms</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/g1/">g1</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gc/">gc</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/io/">io</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jit/">jit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jmm/">jmm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/">jvm</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rocketmq/">rocketmq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcp/">tcp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ä¸­é—´ä»¶/">ä¸­é—´ä»¶</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/å…³é”®å­—/">å…³é”®å­—</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/åˆ†å¸ƒå¼/">åˆ†å¸ƒå¼</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/åŸºç¡€/">åŸºç¡€</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/å¤šçº¿ç¨‹/">å¤šçº¿ç¨‹</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/å¹¶å‘/">å¹¶å‘</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/å¾®æœåŠ¡/">å¾®æœåŠ¡</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/æ”»å‡»/">æ”»å‡»</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/æºç /">æºç </a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ç½‘ç»œ/">ç½‘ç»œ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/è®¾è®¡æ¨¡å¼/">è®¾è®¡æ¨¡å¼</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/é”/">é”</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/éšç¬”/">éšç¬”</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/é›†åˆ/">é›†åˆ</a><span class="tag-list-count">5</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">æ ‡ç­¾äº‘</h3>
    <div class="widget tagcloud">
      <a href="/tags/cms/" style="font-size: 11.25px;">cms</a> <a href="/tags/g1/" style="font-size: 11.25px;">g1</a> <a href="/tags/gc/" style="font-size: 11.25px;">gc</a> <a href="/tags/io/" style="font-size: 10px;">io</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/jit/" style="font-size: 10px;">jit</a> <a href="/tags/jmm/" style="font-size: 11.25px;">jmm</a> <a href="/tags/jvm/" style="font-size: 17.5px;">jvm</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/redis/" style="font-size: 11.25px;">redis</a> <a href="/tags/rocketmq/" style="font-size: 10px;">rocketmq</a> <a href="/tags/tcp/" style="font-size: 10px;">tcp</a> <a href="/tags/ä¸­é—´ä»¶/" style="font-size: 13.75px;">ä¸­é—´ä»¶</a> <a href="/tags/å…³é”®å­—/" style="font-size: 11.25px;">å…³é”®å­—</a> <a href="/tags/åˆ†å¸ƒå¼/" style="font-size: 12.5px;">åˆ†å¸ƒå¼</a> <a href="/tags/åŸºç¡€/" style="font-size: 16.25px;">åŸºç¡€</a> <a href="/tags/å¤šçº¿ç¨‹/" style="font-size: 15px;">å¤šçº¿ç¨‹</a> <a href="/tags/å¹¶å‘/" style="font-size: 15px;">å¹¶å‘</a> <a href="/tags/å¾®æœåŠ¡/" style="font-size: 10px;">å¾®æœåŠ¡</a> <a href="/tags/æ”»å‡»/" style="font-size: 10px;">æ”»å‡»</a> <a href="/tags/æºç /" style="font-size: 18.75px;">æºç </a> <a href="/tags/ç½‘ç»œ/" style="font-size: 10px;">ç½‘ç»œ</a> <a href="/tags/è®¾è®¡æ¨¡å¼/" style="font-size: 10px;">è®¾è®¡æ¨¡å¼</a> <a href="/tags/é”/" style="font-size: 10px;">é”</a> <a href="/tags/éšç¬”/" style="font-size: 10px;">éšç¬”</a> <a href="/tags/é›†åˆ/" style="font-size: 15px;">é›†åˆ</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">å½’æ¡£</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">å…­æœˆ 2018</a><span class="archive-list-count">40</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">æœ€æ–°æ–‡ç« </h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/06/24/RocketMQç¬”è®°/">RocketMQç¬”è®°</a>
          </li>
        
          <li>
            <a href="/2018/06/24/å¾®æœåŠ¡/">å¾®æœåŠ¡</a>
          </li>
        
          <li>
            <a href="/2018/06/24/åˆ†å¸ƒå¼é”/">åˆ†å¸ƒå¼é”</a>
          </li>
        
          <li>
            <a href="/2018/06/24/åˆ†å¸ƒå¼ç†è®º/">åˆ†å¸ƒå¼ç†è®º</a>
          </li>
        
          <li>
            <a href="/2018/06/24/ç¼“å­˜é¢„çƒ­ï¼Œç¼“å­˜ç©¿é€ï¼Œç¼“å­˜é›ªå´©/">ç¼“å­˜é¢„çƒ­ï¼Œç¼“å­˜ç©¿é€ï¼Œç¼“å­˜é›ªå´©</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 é™ˆæ–Œ<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>